(function(){"use strict";const y={w:100,h:100},T=.001,j=424242;function P(e,t,n){return Math.min(n,Math.max(t,e))}function F(e){let t=e;return()=>{t|=0,t=t+1831565813|0;let n=Math.imul(t^t>>>15,1|t);return n^=n+Math.imul(n^n>>>7,61|n),((n^n>>>14)>>>0)/4294967296}}function m(e){return e.map(t=>({x:t.x,y:t.y}))}function p(e){const t=new Float32Array(2*e.length);for(let n=0;n<e.length;n+=1)t[2*n]=e[n].x,t[2*n+1]=e[n].y;return t}function I(e,t,n=j){const o=F(n),l=[],s=1.95*t;for(let c=0;c<e;c+=1){let h=!1;for(let r=0;r<180;r+=1){const u={x:t+(y.w-2*t)*o(),y:t+(y.h-2*t)*o()};let i=!0;for(let d=0;d<l.length;d+=1){const f=l[d];if(Math.hypot(u.x-f.x,u.y-f.y)<s){i=!1;break}}if(i){l.push(u),h=!0;break}}if(!h)break}return l}function b(e,t){let n=0;const o=2*t;for(let l=0;l<e.length;l+=1){const s=e[l];for(let c=l+1;c<e.length;c+=1){const h=e[c],r=Math.hypot(s.x-h.x,s.y-h.y);r<o&&(n+=o-r)}}return n}function q(e){let t=0;for(let n=0;n<e.length;n+=1)t+=e[n].x*e[n].x+e[n].y*e[n].y;return Math.sqrt(t)}function N(e,t){let n=0;for(let o=0;o<e.length;o+=1){const l=e[o].x-t[o].x,s=e[o].y-t[o].y;n+=l*l+s*s}return Math.sqrt(n)}function k(e,t){e.x=P(e.x,t,y.w-t),e.y=P(e.y,t,y.h-t)}function R(e,t,n,o){const l=.5*y.w,s=.5*y.h,c=.0125*n;for(let h=0;h<e.length;h+=1){const r=e[h];r.x+=t*(-c*(r.x-l)),r.y+=t*(-c*(r.y-s)),k(r,o)}}function A(e,t,n){let o=t.x-e.x,l=t.y-e.y,s=Math.hypot(o,l);const c=2*n;if(s>=c)return;s<1e-10&&(o=1,l=0,s=1);const h=c-s,r=o/s,u=l/s,i=.5*h;e.x-=i*r,e.y-=i*u,t.x+=i*r,t.y+=i*u}function w(e,t){for(let n=0;n<e.length;n+=1)for(let o=n+1;o<e.length;o+=1)A(e[n],e[o],t);for(let n=0;n<e.length;n+=1)k(e[n],t)}function B(e,t){const n=m(e);return{particles:n,t:0,dtCurrent:t.dtBase,pendingFrames:0,lastK:1,overlap:b(n,t.R)}}function C(e,t,n){const o=m(e.particles);return R(o,n,t.alpha,t.R),w(o,t.R),{particles:o,t:e.t+n,dtCurrent:n,pendingFrames:0,lastK:1,overlap:b(o,t.R)}}function U(e,t,n){const o=m(e.particles),l=o.map(()=>({x:0,y:0})),s=.5*y.w,c=.5*y.h,h=.0125*t.alpha;for(let r=0;r<o.length;r+=1)l[r].x+=-h*(o[r].x-s),l[r].y+=-h*(o[r].y-c);for(let r=0;r<o.length;r+=1)for(let u=r+1;u<o.length;u+=1){let i=o[r].x-o[u].x,d=o[r].y-o[u].y,f=Math.hypot(i,d);const a=2*t.R;if(f>=a)continue;f<1e-10&&(i=1,d=0,f=1);const x=a-f,M=i/f,K=d/f,D=t.gamma*x;l[r].x+=D*M,l[r].y+=D*K,l[u].x-=D*M,l[u].y-=D*K}for(let r=0;r<o.length;r+=1)o[r].x+=n*l[r].x,o[r].y+=n*l[r].y,k(o[r],t.R);return{particles:o,t:e.t+n,dtCurrent:n,pendingFrames:0,lastK:1,overlap:b(o,t.R)}}function W(e,t,n=t.T){const o=t.budgetMode?e.dtCurrent:t.dtBase,l=Math.max(0,Math.min(o,n-e.t));if(l<=0)return{state:e,kStar:e.lastK||1};const s=m(e.particles);R(s,l,t.alpha,t.R);const c=s;let h=1;for(let u=1;u<=t.maxIter;u+=1){const i=m(c);w(c,t.R);const d=N(c,i),f=q(c);if(h=u,d<=t.atol+t.rtol*f)break}const r=Math.max(1,h);return{state:{particles:c,t:e.t+l,dtCurrent:t.budgetMode?r*t.dtBase:t.dtBase,pendingFrames:t.budgetMode?r:0,lastK:r,overlap:b(c,t.R)},kStar:r}}function _(e,t,n=t.T){if(t.competitor==="NPGS")return{...W(e,t,n).state,pendingFrames:0};const o=Math.max(0,Math.min(t.dtBase,n-e.t));return o<=0?e:U(e,t,o)}function G(e,t){if(e.length===0)return null;const n=e.length-1,o=Math.floor(t/T),l=Math.min(o,n),s=Math.min(l+1,n),c=l*T,h=s*T,r=h>c?(t-c)/(h-c):0,u=e[l],i=e[s];if(!u||!i)return null;const d=Math.floor(Math.min(u.length,i.length)/2),f=[];for(let a=0;a<d;a+=1){const x=u[2*a]+r*(i[2*a]-u[2*a]),M=u[2*a+1]+r*(i[2*a+1]-u[2*a+1]);f.push({x,y:M})}return f}function O(e,t,n){const o=Math.min(e.length,t.length);let l=0;for(let s=0;s<o;s+=1){const c=e[s].x-t[s].x,h=e[s].y-t[s].y;l+=c*c+h*h}return Math.sqrt(l)/Math.max(1,n)}let g=0;const E=200,H=300;function v(e){self.postMessage(e)}self.onmessage=e=>{const t=e.data;if(!t||t.type!=="computeAll")return;g+=1;const n=g,{params:o,seed:l,signature:s}=t.payload,c=I(o.N,o.R,l),h=[],r=Math.ceil(o.T/T);let u=B(c,o);h.push(p(u.particles));let i=0;const d=()=>{if(n!==g)return;let f=0;for(;i<r&&f<E;){const a=Math.max(0,Math.min(T,o.T-u.t));if(a<=0)break;u=C(u,o,a),h.push(p(u.particles)),i+=1,f+=1,i%H===0&&v({type:"simulationProgress",payload:{ratio:i/r*.6,phase:"reference"}})}i<r&&u.t<o.T?setTimeout(d,0):(v({type:"simulationProgress",payload:{ratio:.6,phase:"reference"}}),setTimeout(()=>z(n,o,c,h,s),0))};d()};function z(e,t,n,o,l){if(e!==g)return;const s=[];let c=B(n,t);const h=S(c,o,t);s.push({t:0,particles:p(c.particles),overlap:c.overlap,error:h,dtUsed:t.dtBase,lastK:1});let r=0;for(;c.t<t.T&&r<2e5;){const a=Math.max(0,Math.min(t.dtBase,t.T-c.t));if(a<=0)break;c=C(c,t,a);const x=S(c,o,t);s.push({t:c.t,particles:p(c.particles),overlap:c.overlap,error:x,dtUsed:a,lastK:1}),r+=1}if(e!==g)return;v({type:"simulationProgress",payload:{ratio:.8,phase:"pbd"}});const u=[];let i=B(n,t);const d=S(i,o,t);u.push({t:0,particles:p(i.particles),overlap:i.overlap,error:d,dtUsed:t.dtBase,lastK:1});const f=()=>{if(e!==g)return;let a=0;for(;i.t<t.T&&a<E;){const x=i.t;if(i=_(i,t,t.T),Math.abs(i.t-x)<1e-15)break;const M=S(i,o,t);u.push({t:i.t,particles:p(i.particles),overlap:i.overlap,error:M,dtUsed:i.dtCurrent,lastK:i.lastK}),a+=1}i.t<t.T-1e-12?(v({type:"simulationProgress",payload:{ratio:.8+.2*(i.t/t.T),phase:"competitor"}}),setTimeout(f,0)):v({type:"simulationDone",payload:{signature:l,pbdTrajectory:s,compTrajectory:u,refStates:o}})};setTimeout(f,0)}function S(e,t,n){const o=G(t,e.t);return o?O(e.particles,o,n.N):null}})();
